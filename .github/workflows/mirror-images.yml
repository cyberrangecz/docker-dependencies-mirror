name: Mirror Docker Images to GHCR

on:
  schedule:
    # Every Monday at 2:00
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if image exists'
        required: false
        type: boolean
        default: false

env:
  REGISTRY: ghcr.io

jobs:
  mirror:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "redis"
            upstream: "redis"
            tag: "6.2.6"
          - name: "syslog-ng"
            upstream: "balabit/syslog-ng"
            tag: "latest"
          - name: "guacd"
            upstream: "guacamole/guacd"
            tag: "1.6.0"

    steps:
      - name: Lowercase Repository Name
        id: repo_lower
        run: echo "repo=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Set image variables
        id: images
        run: |
          SRC="docker://docker.io/${{ matrix.upstream }}:${{ matrix.tag }}"
          DEST="docker://${{ env.REGISTRY }}/${{ steps.repo_lower.outputs.repo }}/${{ matrix.name }}:${{ matrix.tag }}"
          echo "source=$SRC" >> $GITHUB_OUTPUT
          echo "destination=$DEST" >> $GITHUB_OUTPUT

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Skopeo
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y skopeo > /dev/null

      - name: Check if update needed
        id: check
        if: github.event.inputs.force_update != 'true'
        continue-on-error: true
        run: |
          # Get source digest
          SRC_DIGEST=$(skopeo inspect --override-arch=amd64 ${{ steps.images.outputs.source }} | jq -r '.Digest')
          echo "Source digest: $SRC_DIGEST"

          # Try to get destination digest
          DEST_DIGEST=$(skopeo inspect --override-arch=amd64 ${{ steps.images.outputs.destination }} 2>/dev/null | jq -r '.Digest' || echo "not-found")
          echo "Destination digest: $DEST_DIGEST"

          if [ "$SRC_DIGEST" = "$DEST_DIGEST" ]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Image already up to date, skipping"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "Will be updated (source: $SRC_DIGEST, dest: $DEST_DIGEST)"
          fi

      - name: Mirror ${{ matrix.name }}:${{ matrix.tag }}
        if: steps.check.outputs.skip != 'true'
        run: |
          echo "----------------------------------------"
          echo "Mirroring (amd64):"
          echo "  From: ${{ steps.images.outputs.source }}"
          echo "  To:   ${{ steps.images.outputs.destination }}"
          echo "----------------------------------------"

          skopeo copy \
            --override-arch=amd64 \
            --override-os=linux \
            --src-tls-verify=true \
            --dest-tls-verify=true \
            --retry-times=3 \
            ${{ steps.images.outputs.source }} \
            ${{ steps.images.outputs.destination }}

          echo "Successfully mirrored ${{ matrix.name }}:${{ matrix.tag }}"

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Failed to mirror ${{ matrix.name }}:${{ matrix.tag }}"
          echo "Mirror Failed: ${{ matrix.name }}:${{ matrix.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs for details." >> $GITHUB_STEP_SUMMARY
